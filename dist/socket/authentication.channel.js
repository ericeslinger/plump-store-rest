"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var socket_1 = require("./socket");
var rxjs_1 = require("rxjs");
var ulid = require("ulid");
function testAuthentication(store, key) {
    return socket_1.rpc(store.io, 'auth', {
        request: 'testkey',
        key: key,
    }).then(function (v) {
        if (v.auth && v.included) {
            v.included.forEach(function (val) { return store.fireReadUpdate(val); });
        }
        return v.auth;
    });
}
exports.testAuthentication = testAuthentication;
function authenticate(store) {
    var nonce = ulid();
    var subj = new rxjs_1.Subject();
    store.io.once(nonce, function (result) {
        if (result.status === 'success') {
            if (result.included) {
                result.included.forEach(function (val) { return store.fireReadUpdate(val); });
            }
            subj.next({
                token: result.token,
                response: 'token',
                result: 'success',
            });
            subj.complete();
        }
        else {
            subj.error(result);
        }
    });
    socket_1.rpc(store.io, 'auth', {
        request: 'startauth',
        nonce: nonce,
    }).then(function (r) {
        subj.next(r);
    });
    return subj.asObservable();
}
exports.authenticate = authenticate;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zb2NrZXQvYXV0aGVudGljYXRpb24uY2hhbm5lbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLG1DQUErQjtBQU8vQiw2QkFBMkM7QUFDM0MsMkJBQTZCO0FBRTdCLDRCQUNFLEtBQWdCLEVBQ2hCLEdBQVc7SUFFWCxNQUFNLENBQUMsWUFBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFO1FBQzNCLE9BQU8sRUFBRSxTQUFTO1FBQ2xCLEdBQUcsRUFBRSxHQUFHO0tBQ1QsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQWU7UUFDdEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUN6QixDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEtBQUssQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQXpCLENBQXlCLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBYkQsZ0RBYUM7QUFFRCxzQkFDRSxLQUFnQjtJQUVoQixJQUFNLEtBQUssR0FBRyxJQUFJLEVBQUUsQ0FBQztJQUNyQixJQUFNLElBQUksR0FBRyxJQUFJLGNBQU8sRUFBaUMsQ0FBQztJQUMxRCxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsVUFBQSxNQUFNO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNoQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFLLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUF6QixDQUF5QixDQUFDLENBQUM7WUFDNUQsQ0FBQztZQUNELElBQUksQ0FBQyxJQUFJLENBQUM7Z0JBQ1IsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2dCQUNuQixRQUFRLEVBQUUsT0FBTztnQkFDakIsTUFBTSxFQUFFLFNBQVM7YUFDbEIsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2xCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckIsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsWUFBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFO1FBQ3BCLE9BQU8sRUFBRSxXQUFXO1FBQ3BCLEtBQUssRUFBRSxLQUFLO0tBQ2IsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQWdCO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDZixDQUFDLENBQUMsQ0FBQztJQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDN0IsQ0FBQztBQTNCRCxvQ0EyQkMiLCJmaWxlIjoic29ja2V0L2F1dGhlbnRpY2F0aW9uLmNoYW5uZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBTb2NrZXRJT0NsaWVudCBmcm9tICdzb2NrZXQuaW8tY2xpZW50JztcbmltcG9ydCB7IHJwYyB9IGZyb20gJy4vc29ja2V0JztcbmltcG9ydCB7XG4gIFRlc3RSZXNwb25zZSxcbiAgU3RhcnRSZXNwb25zZSxcbiAgVG9rZW5SZXNwb25zZSxcbn0gZnJvbSAnLi9tZXNzYWdlSW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBSZXN0U3RvcmUgfSBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIHVsaWQgZnJvbSAndWxpZCc7XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXN0QXV0aGVudGljYXRpb24oXG4gIHN0b3JlOiBSZXN0U3RvcmUsXG4gIGtleTogc3RyaW5nLFxuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHJldHVybiBycGMoc3RvcmUuaW8sICdhdXRoJywge1xuICAgIHJlcXVlc3Q6ICd0ZXN0a2V5JyxcbiAgICBrZXk6IGtleSxcbiAgfSkudGhlbigodjogVGVzdFJlc3BvbnNlKSA9PiB7XG4gICAgaWYgKHYuYXV0aCAmJiB2LmluY2x1ZGVkKSB7XG4gICAgICB2LmluY2x1ZGVkLmZvckVhY2godmFsID0+IHN0b3JlLmZpcmVSZWFkVXBkYXRlKHZhbCkpO1xuICAgIH1cbiAgICByZXR1cm4gdi5hdXRoO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF1dGhlbnRpY2F0ZShcbiAgc3RvcmU6IFJlc3RTdG9yZSxcbik6IE9ic2VydmFibGU8VG9rZW5SZXNwb25zZSB8IFN0YXJ0UmVzcG9uc2U+IHtcbiAgY29uc3Qgbm9uY2UgPSB1bGlkKCk7XG4gIGNvbnN0IHN1YmogPSBuZXcgU3ViamVjdDxUb2tlblJlc3BvbnNlIHwgU3RhcnRSZXNwb25zZT4oKTtcbiAgc3RvcmUuaW8ub25jZShub25jZSwgcmVzdWx0ID0+IHtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnKSB7XG4gICAgICBpZiAocmVzdWx0LmluY2x1ZGVkKSB7XG4gICAgICAgIHJlc3VsdC5pbmNsdWRlZC5mb3JFYWNoKHZhbCA9PiBzdG9yZS5maXJlUmVhZFVwZGF0ZSh2YWwpKTtcbiAgICAgIH1cbiAgICAgIHN1YmoubmV4dCh7XG4gICAgICAgIHRva2VuOiByZXN1bHQudG9rZW4sXG4gICAgICAgIHJlc3BvbnNlOiAndG9rZW4nLFxuICAgICAgICByZXN1bHQ6ICdzdWNjZXNzJyxcbiAgICAgIH0pO1xuICAgICAgc3Viai5jb21wbGV0ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWJqLmVycm9yKHJlc3VsdCk7XG4gICAgfVxuICB9KTtcbiAgcnBjKHN0b3JlLmlvLCAnYXV0aCcsIHtcbiAgICByZXF1ZXN0OiAnc3RhcnRhdXRoJyxcbiAgICBub25jZTogbm9uY2UsXG4gIH0pLnRoZW4oKHI6IFN0YXJ0UmVzcG9uc2UpID0+IHtcbiAgICBzdWJqLm5leHQocik7XG4gIH0pO1xuICByZXR1cm4gc3Viai5hc09ic2VydmFibGUoKTtcbn1cbiJdfQ==
