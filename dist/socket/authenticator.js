"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ulid = require("ulid");
var rxjs_1 = require("rxjs");
var Authenticator = (function () {
    function Authenticator(store) {
        var _this = this;
        this.store = store;
        this._key$ = new rxjs_1.BehaviorSubject(null);
        this._state$ = new rxjs_1.BehaviorSubject('untested');
        this._method$ = new rxjs_1.Subject();
        this._you$ = new rxjs_1.Subject();
        this.state$ = this._state$.asObservable();
        this.key$ = this._key$.asObservable();
        this.method$ = this._method$.asObservable();
        this.you$ = this._you$.asObservable();
        this.nonce = ulid();
        this.store.io.on(this.nonce, function (msg) {
            switch (msg.response) {
                case 'token':
                    return _this.dispatchToken(msg);
                case 'startauth':
                    return _this.dispatchStart(msg);
                case 'invalidRequest':
                    return _this.dispatchInvalid(msg);
                case 'testkey':
                    return _this.dispatchTestKey(msg);
            }
        });
    }
    Authenticator.prototype.dispatchToken = function (msg) {
        if (msg.status === 'success') {
            this._state$.next('testing');
            this.attemptKey(msg.token);
        }
    };
    Authenticator.prototype.dispatchStart = function (msg) {
        this._method$.next(msg.types);
    };
    Authenticator.prototype.dispatchInvalid = function (msg) {
        this._state$.next('error');
        console.log('Error - invalid authentication channel message sent');
        console.log(msg);
    };
    Authenticator.prototype.dispatchTestKey = function (msg) {
        var _this = this;
        if (msg.auth === true) {
            this.store.axios.defaults.headers.common['Authorization'] = "Bearer " + msg.token;
            this._key$.next(msg.token);
            if (msg.you) {
                this._you$.next(msg.you);
            }
            if (msg.included) {
                msg.included.forEach(function (val) { return _this.store.fireReadUpdate(val); });
            }
            this._state$.next('ready');
        }
        else {
            console.log('invalid key');
            this.initiateLogin();
        }
    };
    Authenticator.prototype.attemptKey = function (k) {
        this._state$.next('testing');
        var req = {
            request: 'testkey',
            key: k,
            responseKey: this.nonce,
        };
        this.store.io.emit('auth', req);
    };
    Authenticator.prototype.initiateLogin = function () {
        this._state$.next('invalid');
        var req = {
            request: 'startauth',
            nonce: this.nonce,
            responseKey: this.nonce,
        };
        this.store.io.emit('auth', req);
    };
    return Authenticator;
}());
exports.Authenticator = Authenticator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zb2NrZXQvYXV0aGVudGljYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJCQUE2QjtBQUM3Qiw2QkFBNEQ7QUFvQjVEO0lBaUJFLHVCQUFtQixLQUFnQjtRQUFuQyxpQkFrQkM7UUFsQmtCLFVBQUssR0FBTCxLQUFLLENBQVc7UUFUNUIsVUFBSyxHQUFvQixJQUFJLHNCQUFlLENBQVMsSUFBSSxDQUFDLENBQUM7UUFDM0QsWUFBTyxHQUFpQyxJQUFJLHNCQUFlLENBRWhFLFVBQVUsQ0FBQyxDQUFDO1FBQ1AsYUFBUSxHQUFrQyxJQUFJLGNBQU8sRUFFekQsQ0FBQztRQUNHLFVBQUssR0FBaUIsSUFBSSxjQUFPLEVBQU8sQ0FBQztRQUc5QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxVQUFDLEdBQTJCO1lBQ3ZELE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixLQUFLLE9BQU87b0JBQ1YsTUFBTSxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pDLEtBQUssV0FBVztvQkFDZCxNQUFNLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakMs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LEtBQUs7WUFDakIsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLO1NBQ3hCLENBQUM7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDSCxvQkFBQztBQUFELENBN0ZBLEFBNkZDLElBQUE7QUE3Rlksc0NBQWEiLCJmaWxlIjoic29ja2V0L2F1dGhlbnRpY2F0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1bGlkIGZyb20gJ3VsaWQnO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSZXN0U3RvcmUgfSBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IHJwYyB9IGZyb20gJy4vc29ja2V0JztcbmltcG9ydCB7XG4gIFRlc3RLZXlBdXRoZW50aWNhdGlvblJlcXVlc3QsXG4gIFN0YXJ0QXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBTdGFydFJlc3BvbnNlLFxuICBUb2tlblJlc3BvbnNlLFxuICBUZXN0UmVzcG9uc2UsXG4gIEF1dGhlbnRpY2F0aW9uUmVzcG9uc2UsXG4gIEF1dGhlbnRpY2F0aW9uVHlwZSxcbn0gZnJvbSAnLi9tZXNzYWdlSW50ZXJmYWNlcyc7XG5cbmV4cG9ydCB0eXBlIEF1dGhlbnRpY2F0b3JTdGF0ZXMgPVxuICB8ICdyZWFkeSdcbiAgfCAndW50ZXN0ZWQnXG4gIHwgJ2Vycm9yJ1xuICB8ICd0ZXN0aW5nJ1xuICB8ICdpbnZhbGlkJztcblxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0b3Ige1xuICBwdWJsaWMgbm9uY2U6IHN0cmluZztcblxuICBwdWJsaWMga2V5JDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuICBwdWJsaWMgc3RhdGUkOiBPYnNlcnZhYmxlPEF1dGhlbnRpY2F0b3JTdGF0ZXM+O1xuICBwdWJsaWMgbWV0aG9kJDogT2JzZXJ2YWJsZTxBdXRoZW50aWNhdGlvblR5cGVbXT47XG4gIHB1YmxpYyB5b3UkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgcHVibGljIF9rZXkkOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4obnVsbCk7XG4gIHB1YmxpYyBfc3RhdGUkOiBTdWJqZWN0PEF1dGhlbnRpY2F0b3JTdGF0ZXM+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxcbiAgICBBdXRoZW50aWNhdG9yU3RhdGVzXG4gID4oJ3VudGVzdGVkJyk7XG4gIHB1YmxpYyBfbWV0aG9kJDogU3ViamVjdDxBdXRoZW50aWNhdGlvblR5cGVbXT4gPSBuZXcgU3ViamVjdDxcbiAgICBBdXRoZW50aWNhdGlvblR5cGVbXVxuICA+KCk7XG4gIHB1YmxpYyBfeW91JDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdG9yZTogUmVzdFN0b3JlKSB7XG4gICAgdGhpcy5zdGF0ZSQgPSB0aGlzLl9zdGF0ZSQuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5rZXkkID0gdGhpcy5fa2V5JC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLm1ldGhvZCQgPSB0aGlzLl9tZXRob2QkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMueW91JCA9IHRoaXMuX3lvdSQuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5ub25jZSA9IHVsaWQoKTtcbiAgICB0aGlzLnN0b3JlLmlvLm9uKHRoaXMubm9uY2UsIChtc2c6IEF1dGhlbnRpY2F0aW9uUmVzcG9uc2UpID0+IHtcbiAgICAgIHN3aXRjaCAobXNnLnJlc3BvbnNlKSB7XG4gICAgICAgIGNhc2UgJ3Rva2VuJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaFRva2VuKG1zZyk7XG4gICAgICAgIGNhc2UgJ3N0YXJ0YXV0aCc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hTdGFydChtc2cpO1xuICAgICAgICBjYXNlICdpbnZhbGlkUmVxdWVzdCc6XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hJbnZhbGlkKG1zZyk7XG4gICAgICAgIGNhc2UgJ3Rlc3RrZXknOlxuICAgICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoVGVzdEtleShtc2cpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZGlzcGF0Y2hUb2tlbihtc2c6IFRva2VuUmVzcG9uc2UpIHtcbiAgICBpZiAobXNnLnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnKSB7XG4gICAgICB0aGlzLl9zdGF0ZSQubmV4dCgndGVzdGluZycpO1xuICAgICAgdGhpcy5hdHRlbXB0S2V5KG1zZy50b2tlbik7XG4gICAgfVxuICB9XG5cbiAgZGlzcGF0Y2hTdGFydChtc2c6IFN0YXJ0UmVzcG9uc2UpIHtcbiAgICB0aGlzLl9tZXRob2QkLm5leHQobXNnLnR5cGVzKTtcbiAgfVxuXG4gIGRpc3BhdGNoSW52YWxpZChtc2cpIHtcbiAgICB0aGlzLl9zdGF0ZSQubmV4dCgnZXJyb3InKTtcbiAgICBjb25zb2xlLmxvZygnRXJyb3IgLSBpbnZhbGlkIGF1dGhlbnRpY2F0aW9uIGNoYW5uZWwgbWVzc2FnZSBzZW50Jyk7XG4gICAgY29uc29sZS5sb2cobXNnKTtcbiAgfVxuXG4gIGRpc3BhdGNoVGVzdEtleShtc2c6IFRlc3RSZXNwb25zZSkge1xuICAgIGlmIChtc2cuYXV0aCA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5zdG9yZS5heGlvcy5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbltcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nXG4gICAgICBdID0gYEJlYXJlciAke21zZy50b2tlbn1gO1xuICAgICAgdGhpcy5fa2V5JC5uZXh0KG1zZy50b2tlbik7XG4gICAgICBpZiAobXNnLnlvdSkge1xuICAgICAgICB0aGlzLl95b3UkLm5leHQobXNnLnlvdSk7XG4gICAgICB9XG4gICAgICBpZiAobXNnLmluY2x1ZGVkKSB7XG4gICAgICAgIG1zZy5pbmNsdWRlZC5mb3JFYWNoKHZhbCA9PiB0aGlzLnN0b3JlLmZpcmVSZWFkVXBkYXRlKHZhbCkpO1xuICAgICAgfVxuICAgICAgdGhpcy5fc3RhdGUkLm5leHQoJ3JlYWR5Jyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKCdpbnZhbGlkIGtleScpO1xuICAgICAgdGhpcy5pbml0aWF0ZUxvZ2luKCk7XG4gICAgfVxuICAgIC8qIG5vb3AgKi9cbiAgfVxuXG4gIGF0dGVtcHRLZXkoazogc3RyaW5nKSB7XG4gICAgdGhpcy5fc3RhdGUkLm5leHQoJ3Rlc3RpbmcnKTtcbiAgICBjb25zdCByZXE6IFRlc3RLZXlBdXRoZW50aWNhdGlvblJlcXVlc3QgPSB7XG4gICAgICByZXF1ZXN0OiAndGVzdGtleScsXG4gICAgICBrZXk6IGssXG4gICAgICByZXNwb25zZUtleTogdGhpcy5ub25jZSxcbiAgICB9O1xuICAgIHRoaXMuc3RvcmUuaW8uZW1pdCgnYXV0aCcsIHJlcSk7XG4gIH1cblxuICBpbml0aWF0ZUxvZ2luKCkge1xuICAgIHRoaXMuX3N0YXRlJC5uZXh0KCdpbnZhbGlkJyk7XG4gICAgY29uc3QgcmVxOiBTdGFydEF1dGhlbnRpY2F0aW9uUmVxdWVzdCA9IHtcbiAgICAgIHJlcXVlc3Q6ICdzdGFydGF1dGgnLFxuICAgICAgbm9uY2U6IHRoaXMubm9uY2UsXG4gICAgICByZXNwb25zZUtleTogdGhpcy5ub25jZSxcbiAgICB9O1xuICAgIHRoaXMuc3RvcmUuaW8uZW1pdCgnYXV0aCcsIHJlcSk7XG4gIH1cbn1cbiJdfQ==
