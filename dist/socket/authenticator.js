"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ulid = require("ulid");
var rxjs_1 = require("rxjs");
var Authenticator = (function () {
    function Authenticator(store) {
        var _this = this;
        this.store = store;
        this._key$ = new rxjs_1.BehaviorSubject(null);
        this._state$ = new rxjs_1.BehaviorSubject('untested');
        this._method$ = new rxjs_1.Subject();
        this._you$ = new rxjs_1.Subject();
        this.state$ = this._state$.asObservable();
        this.key$ = this._key$.asObservable();
        this.method$ = this._method$.asObservable();
        this.you$ = this._you$.asObservable();
        this.nonce = ulid();
        this.store.io.on(this.nonce, function (msg) {
            switch (msg.response) {
                case 'token':
                    return _this.dispatchToken(msg);
                case 'startauth':
                    return _this.dispatchStart(msg);
                case 'invalidRequest':
                    return _this.dispatchInvalid(msg);
                case 'testkey':
                    return _this.dispatchTestKey(msg);
            }
        });
    }
    Authenticator.prototype.dispatchToken = function (msg) {
        if (msg.status === 'success') {
            this._state$.next('testing');
            this.attemptKey(msg.token);
        }
    };
    Authenticator.prototype.dispatchStart = function (msg) {
        this._method$.next(msg.types);
    };
    Authenticator.prototype.dispatchInvalid = function (msg) {
        this._state$.next('error');
        console.log('Error - invalid authentication channel message sent');
        console.log(msg);
    };
    Authenticator.prototype.dispatchTestKey = function (msg) {
        var _this = this;
        if (msg.auth === true) {
            this.store.axios.defaults.headers.common['Authorization'] = "Bearer " + msg.token;
            this._key$.next(msg.token);
            if (msg.you) {
                this._you$.next(msg.you);
            }
            if (msg.included) {
                msg.included.forEach(function (val) { return _this.store.fireReadUpdate(val); });
            }
            this._state$.next('ready');
        }
        else {
            console.log('invalid key');
            this.initiateLogin();
        }
    };
    Authenticator.prototype.attemptKey = function (k) {
        this._state$.next('testing');
        var req = {
            request: 'testkey',
            key: k,
            responseKey: this.nonce,
        };
        this.store.io.emit('auth', req);
    };
    Authenticator.prototype.initiateLogin = function () {
        this._state$.next('invalid');
        var req = {
            request: 'startauth',
            nonce: this.nonce,
            responseKey: this.nonce,
        };
        this.store.io.emit('auth', req);
    };
    return Authenticator;
}());
exports.Authenticator = Authenticator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zb2NrZXQvYXV0aGVudGljYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJCQUE2QjtBQUM3Qiw2QkFBNEQ7QUFvQjVEO0lBaUJFLHVCQUFtQixLQUFnQjtRQUFuQyxpQkFrQkM7UUFsQmtCLFVBQUssR0FBTCxLQUFLLENBQVc7UUFUM0IsVUFBSyxHQUFvQixJQUFJLHNCQUFlLENBQVMsSUFBSSxDQUFDLENBQUM7UUFDM0QsWUFBTyxHQUFpQyxJQUFJLHNCQUFlLENBRWpFLFVBQVUsQ0FBQyxDQUFDO1FBQ04sYUFBUSxHQUFrQyxJQUFJLGNBQU8sRUFFMUQsQ0FBQztRQUNJLFVBQUssR0FBaUIsSUFBSSxjQUFPLEVBQU8sQ0FBQztRQUcvQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxVQUFDLEdBQTJCO1lBQ3ZELE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixLQUFLLE9BQU87b0JBQ1YsTUFBTSxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pDLEtBQUssV0FBVztvQkFDZCxNQUFNLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakMs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LEtBQUs7WUFDakIsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLO1NBQ3hCLENBQUM7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDSCxvQkFBQztBQUFELENBN0ZBLEFBNkZDLElBQUE7QUE3Rlksc0NBQWEiLCJmaWxlIjoic29ja2V0L2F1dGhlbnRpY2F0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1bGlkIGZyb20gJ3VsaWQnO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSZXN0U3RvcmUgfSBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IHJwYyB9IGZyb20gJy4vc29ja2V0JztcbmltcG9ydCB7XG4gIFRlc3RLZXlBdXRoZW50aWNhdGlvblJlcXVlc3QsXG4gIFN0YXJ0QXV0aGVudGljYXRpb25SZXF1ZXN0LFxuICBTdGFydFJlc3BvbnNlLFxuICBUb2tlblJlc3BvbnNlLFxuICBUZXN0UmVzcG9uc2UsXG4gIEF1dGhlbnRpY2F0aW9uUmVzcG9uc2UsXG4gIEF1dGhlbnRpY2F0aW9uVHlwZSxcbn0gZnJvbSAnLi9tZXNzYWdlSW50ZXJmYWNlcyc7XG5cbmV4cG9ydCB0eXBlIEF1dGhlbnRpY2F0b3JTdGF0ZXMgPVxuICB8ICdyZWFkeSdcbiAgfCAndW50ZXN0ZWQnXG4gIHwgJ2Vycm9yJ1xuICB8ICd0ZXN0aW5nJ1xuICB8ICdpbnZhbGlkJztcblxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0b3Ige1xuICBwdWJsaWMgbm9uY2U6IHN0cmluZztcblxuICBwdWJsaWMga2V5JDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuICBwdWJsaWMgc3RhdGUkOiBPYnNlcnZhYmxlPEF1dGhlbnRpY2F0b3JTdGF0ZXM+O1xuICBwdWJsaWMgbWV0aG9kJDogT2JzZXJ2YWJsZTxBdXRoZW50aWNhdGlvblR5cGVbXT47XG4gIHB1YmxpYyB5b3UkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgcHJpdmF0ZSBfa2V5JDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+KG51bGwpO1xuICBwcml2YXRlIF9zdGF0ZSQ6IFN1YmplY3Q8QXV0aGVudGljYXRvclN0YXRlcz4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgIEF1dGhlbnRpY2F0b3JTdGF0ZXNcbiAgPigndW50ZXN0ZWQnKTtcbiAgcHJpdmF0ZSBfbWV0aG9kJDogU3ViamVjdDxBdXRoZW50aWNhdGlvblR5cGVbXT4gPSBuZXcgU3ViamVjdDxcbiAgICBBdXRoZW50aWNhdGlvblR5cGVbXVxuICA+KCk7XG4gIHByaXZhdGUgX3lvdSQ6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgc3RvcmU6IFJlc3RTdG9yZSkge1xuICAgIHRoaXMuc3RhdGUkID0gdGhpcy5fc3RhdGUkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMua2V5JCA9IHRoaXMuX2tleSQuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5tZXRob2QkID0gdGhpcy5fbWV0aG9kJC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLnlvdSQgPSB0aGlzLl95b3UkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMubm9uY2UgPSB1bGlkKCk7XG4gICAgdGhpcy5zdG9yZS5pby5vbih0aGlzLm5vbmNlLCAobXNnOiBBdXRoZW50aWNhdGlvblJlc3BvbnNlKSA9PiB7XG4gICAgICBzd2l0Y2ggKG1zZy5yZXNwb25zZSkge1xuICAgICAgICBjYXNlICd0b2tlbic6XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hUb2tlbihtc2cpO1xuICAgICAgICBjYXNlICdzdGFydGF1dGgnOlxuICAgICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoU3RhcnQobXNnKTtcbiAgICAgICAgY2FzZSAnaW52YWxpZFJlcXVlc3QnOlxuICAgICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoSW52YWxpZChtc2cpO1xuICAgICAgICBjYXNlICd0ZXN0a2V5JzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaFRlc3RLZXkobXNnKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGRpc3BhdGNoVG9rZW4obXNnOiBUb2tlblJlc3BvbnNlKSB7XG4gICAgaWYgKG1zZy5zdGF0dXMgPT09ICdzdWNjZXNzJykge1xuICAgICAgdGhpcy5fc3RhdGUkLm5leHQoJ3Rlc3RpbmcnKTtcbiAgICAgIHRoaXMuYXR0ZW1wdEtleShtc2cudG9rZW4pO1xuICAgIH1cbiAgfVxuXG4gIGRpc3BhdGNoU3RhcnQobXNnOiBTdGFydFJlc3BvbnNlKSB7XG4gICAgdGhpcy5fbWV0aG9kJC5uZXh0KG1zZy50eXBlcyk7XG4gIH1cblxuICBkaXNwYXRjaEludmFsaWQobXNnKSB7XG4gICAgdGhpcy5fc3RhdGUkLm5leHQoJ2Vycm9yJyk7XG4gICAgY29uc29sZS5sb2coJ0Vycm9yIC0gaW52YWxpZCBhdXRoZW50aWNhdGlvbiBjaGFubmVsIG1lc3NhZ2Ugc2VudCcpO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gIH1cblxuICBkaXNwYXRjaFRlc3RLZXkobXNnOiBUZXN0UmVzcG9uc2UpIHtcbiAgICBpZiAobXNnLmF1dGggPT09IHRydWUpIHtcbiAgICAgIHRoaXMuc3RvcmUuYXhpb3MuZGVmYXVsdHMuaGVhZGVycy5jb21tb25bXG4gICAgICAgICdBdXRob3JpemF0aW9uJ1xuICAgICAgXSA9IGBCZWFyZXIgJHttc2cudG9rZW59YDtcbiAgICAgIHRoaXMuX2tleSQubmV4dChtc2cudG9rZW4pO1xuICAgICAgaWYgKG1zZy55b3UpIHtcbiAgICAgICAgdGhpcy5feW91JC5uZXh0KG1zZy55b3UpO1xuICAgICAgfVxuICAgICAgaWYgKG1zZy5pbmNsdWRlZCkge1xuICAgICAgICBtc2cuaW5jbHVkZWQuZm9yRWFjaCh2YWwgPT4gdGhpcy5zdG9yZS5maXJlUmVhZFVwZGF0ZSh2YWwpKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX3N0YXRlJC5uZXh0KCdyZWFkeScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZygnaW52YWxpZCBrZXknKTtcbiAgICAgIHRoaXMuaW5pdGlhdGVMb2dpbigpO1xuICAgIH1cbiAgICAvKiBub29wICovXG4gIH1cblxuICBhdHRlbXB0S2V5KGs6IHN0cmluZykge1xuICAgIHRoaXMuX3N0YXRlJC5uZXh0KCd0ZXN0aW5nJyk7XG4gICAgY29uc3QgcmVxOiBUZXN0S2V5QXV0aGVudGljYXRpb25SZXF1ZXN0ID0ge1xuICAgICAgcmVxdWVzdDogJ3Rlc3RrZXknLFxuICAgICAga2V5OiBrLFxuICAgICAgcmVzcG9uc2VLZXk6IHRoaXMubm9uY2UsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlLmlvLmVtaXQoJ2F1dGgnLCByZXEpO1xuICB9XG5cbiAgaW5pdGlhdGVMb2dpbigpIHtcbiAgICB0aGlzLl9zdGF0ZSQubmV4dCgnaW52YWxpZCcpO1xuICAgIGNvbnN0IHJlcTogU3RhcnRBdXRoZW50aWNhdGlvblJlcXVlc3QgPSB7XG4gICAgICByZXF1ZXN0OiAnc3RhcnRhdXRoJyxcbiAgICAgIG5vbmNlOiB0aGlzLm5vbmNlLFxuICAgICAgcmVzcG9uc2VLZXk6IHRoaXMubm9uY2UsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlLmlvLmVtaXQoJ2F1dGgnLCByZXEpO1xuICB9XG59XG4iXX0=
